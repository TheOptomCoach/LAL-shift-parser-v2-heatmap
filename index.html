<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>UK Locum Optometry Shifts Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
    #map { height: 100vh; }
    #controls {
      position: absolute;
      top: 10px; left: 10px;
      background: white; padding: 10px; z-index: 1000;
      border-radius: 5px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      width: 300px;
    }
    textarea { width: 100%; height: 150px; }
    button, select { margin-top: 5px; width: 100%; }
    #progressContainer {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 5px;
      background-color: rgba(200, 200, 200, 0.3);
      z-index: 2000;
      display: none;
    }
    #progressBar {
      height: 100%;
      width: 0%;
      background-color: #007bff;
      transition: width 0.3s ease;
    }
  </style>
</head>
<body>

<div id="progressContainer"><div id="progressBar"></div></div>

<div id="controls">
  <textarea id="rawData" placeholder="Paste your raw shift data here..."></textarea><br>
  <button id="parseBtn">Parse & Update Map</button>
  <select id="mode">
    <option value="density">Density</option>
    <option value="total">Average Total Pay</option>
    <option value="company">Companies</option>
  </select>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>
const map = L.map('map').setView([52.3555, -1.1743], 6);

L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; OpenStreetMap contributors & CartoDB'
}).addTo(map);

let markersLayer = L.layerGroup().addTo(map);

document.getElementById('parseBtn').addEventListener('click', async () => {
  await updateAll();
});

document.getElementById('mode').addEventListener('change', async () => {
  await updateAll();
});

function showProgress() {
  const container = document.getElementById('progressContainer');
  const bar = document.getElementById('progressBar');
  container.style.display = 'block';
  bar.style.width = '0%';
  setTimeout(() => bar.style.width = '60%', 50);
}

function hideProgress() {
  const bar = document.getElementById('progressBar');
  bar.style.width = '100%';
  setTimeout(() => {
    document.getElementById('progressContainer').style.display = 'none';
    bar.style.width = '0%';
  }, 500);
}

async function updateAll() {
  showProgress();
  try {
    const raw = document.getElementById('rawData').value;
    const shifts = parseData(raw);
    const locations = await geocodeLocations(shifts);
    updateMap(locations);
  } catch (error) {
    alert("Error during processing: " + error.message);
    console.error(error);
  }
  hideProgress();
}

function parseData(raw) {
  const lines = raw.split('\n').map(line => line.trim()).filter(line => line !== '');
  const shifts = [];

  for (let i = 0; i < lines.length; i++) {
    const line = lines[i];

    if (line.match(/Total:\s*£[\d,.]+/)) {
      const totalMatch = line.match(/Total:\s*£([\d,.]+)/);
      const total = totalMatch ? parseFloat(totalMatch[1].replace(/,/g, '')) : null;

      let location = null;
      for (let j = i - 1; j >= 0; j--) {
        if (!lines[j].includes("Logo") && !lines[j].includes("£") && !lines[j].match(/AM|PM/) && lines[j].length > 1 && lines[j].length < 50) {
          location = lines[j];
          break;
        }
      }

      let company = "Unknown";
      for (let j = i - 1; j >= 0; j--) {
        if (lines[j].includes("Logo") || lines[j].toUpperCase().includes("LIMITED") || lines[j].toUpperCase().includes("OPTICIANS") || lines[j].toUpperCase().includes("CONCEPT") || lines[j].toUpperCase().includes("ASDA")) {
          company = lines[j].replace("Logo", "").trim();
          break;
        }
      }

      if (total && location) {
        shifts.push({ location, total, company });
      }
    }
  }

  return shifts;
}

async function geocodeLocations(shifts) {
  const locationMap = {};
  const uniqueLocations = [...new Set(shifts.map(s => s.location))];
  const batchSize = 5;

  for (let i = 0; i < uniqueLocations.length; i += batchSize) {
    const batch = uniqueLocations.slice(i, i + batchSize);

    const batchPromises = batch.map(async location => {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(location + ", UK")}`;
      try {
        const res = await fetch(url);
        const data = await res.json();
        if (data && data.length > 0) {
          return {
            location,
            lat: parseFloat(data[0].lat),
            lon: parseFloat(data[0].lon)
          };
        }
      } catch (e) {
        console.warn(`Failed to geocode ${location}`, e);
      }
      return null;
    });

    const results = await Promise.all(batchPromises);
    results.forEach(loc => {
      if (loc) {
        locationMap[loc.location] = {
          lat: loc.lat,
          lon: loc.lon,
          totals: [],
          companies: new Set(),
          count: 0
        };
      }
    });

    await new Promise(res => setTimeout(res, 1000)); // polite delay
  }

  for (const shift of shifts) {
    const data = locationMap[shift.location];
    if (data) {
      data.totals.push(shift.total);
      data.companies.add(shift.company);
      data.count++;
    }
  }

  return Object.entries(locationMap).map(([loc, data]) => ({
    name: loc,
    lat: data.lat,
    lon: data.lon,
    avgTotal: data.totals.reduce((a, b) => a + b, 0) / data.totals.length,
    count: data.count,
    companies: Array.from(data.companies)
  }));
}

function updateMap(locations) {
  markersLayer.clearLayers();
  const mode = document.getElementById('mode').value;

  if (mode === 'density') {
    for (const loc of locations) {
      const radius = 5 + loc.count * 3;
      const marker = L.circleMarker([loc.lat, loc.lon], {
        radius: radius,
        color: "blue",
        fillOpacity: 0.5
      }).bindPopup(`<b>${loc.name}</b><br>Shifts: ${loc.count}`);
      markersLayer.addLayer(marker);
    }
  } else if (mode === 'total') {
    for (const loc of locations) {
      const color = loc.avgTotal >= 450 ? "green" : loc.avgTotal >= 350 ? "orange" : "red";
      const marker = L.circleMarker([loc.lat, loc.lon], {
        radius: 10,
        color,
        fillOpacity: 0.8
      }).bindPopup(
        `<b>${loc.name}</b><br>` +
        `Avg Total: £${loc.avgTotal.toFixed(2)}<br>` +
        `Shifts Count: ${loc.count}`
      );
      markersLayer.addLayer(marker);
    }
  } else if (mode === 'company') {
    for (const loc of locations) {
      const marker = L.marker([loc.lat, loc.lon])
        .bindPopup(`<b>${loc.name}</b><br>Companies: ${loc.companies.join(", ")}`);
      markersLayer.addLayer(marker);
    }
  }
}
</script>

</body>
</html>
