width: 300px;
}
textarea { width: 100%; height: 150px; }
    button, select { margin-top: 5px; width: 100%; }
    button, select, progress { margin-top: 5px; width: 100%; }
#loading { margin-top: 5px; color: red; font-weight: bold; display: none; }
</style>
</head>
@@ -30,7 +30,7 @@
<option value="rate">Average Rate</option>
<option value="company">Companies</option>
</select>
  <div id="loading">Loading...</div>
  <progress id="progressBar" value="0" max="100" style="display:none;"></progress>
</div>

<div id="map"></div>
@@ -57,12 +57,13 @@
const raw = document.getElementById('rawData').value;
const shifts = parseData(raw);

  document.getElementById('loading').style.display = 'block';
  document.getElementById('progressBar').style.display = 'block';
  document.getElementById('progressBar').value = 0;

const locations = await geocodeLocations(shifts);
updateMap(locations);

  document.getElementById('loading').style.display = 'none';
  document.getElementById('progressBar').style.display = 'none';
}

function parseData(raw) {
@@ -105,7 +106,6 @@
const locationMap = {};
const uniqueLocations = {};

  // Aggregate data first
for (const shift of shifts) {
if (!uniqueLocations[shift.location]) {
uniqueLocations[shift.location] = {
@@ -117,23 +117,45 @@
uniqueLocations[shift.location].companies.add(shift.company);
}

  // Parallel geocode
  const geocodePromises = Object.keys(uniqueLocations).map(async loc => {
    const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(loc + ", UK")}`;
    const res = await fetch(url);
    const data = await res.json();
    if (data && data.length > 0) {
  const keys = Object.keys(uniqueLocations);
  const total = keys.length;

  for (let i = 0; i < total; i++) {
    const loc = keys[i];
    let cached = localStorage.getItem(`geo_${loc}`);

    if (cached) {
      const parsed = JSON.parse(cached);
locationMap[loc] = {
        lat: parseFloat(data[0].lat),
        lon: parseFloat(data[0].lon),
        lat: parsed.lat,
        lon: parsed.lon,
rates: uniqueLocations[loc].shifts,
companies: uniqueLocations[loc].companies,
count: uniqueLocations[loc].shifts.length
};
    } else {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(loc + ", UK")}`;
      const res = await fetch(url);
      const data = await res.json();
      if (data && data.length > 0) {
        const lat = parseFloat(data[0].lat);
        const lon = parseFloat(data[0].lon);

        localStorage.setItem(`geo_${loc}`, JSON.stringify({ lat, lon }));

        locationMap[loc] = {
          lat: lat,
          lon: lon,
          rates: uniqueLocations[loc].shifts,
          companies: uniqueLocations[loc].companies,
          count: uniqueLocations[loc].shifts.length
        };
      }
}
  });

  await Promise.all(geocodePromises);
    // Update progress
    document.getElementById('progressBar').value = ((i + 1) / total) * 100;
  }

return Object.entries(locationMap).map(([loc, data]) => ({
name: loc,
