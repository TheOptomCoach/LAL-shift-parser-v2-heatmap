<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>UK Locum Optometry Shifts Map</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
    #map { height: 100vh; }
    #controls {
      position: absolute;
      top: 10px; left: 10px;
      background: white; padding: 10px; z-index: 1000;
      border-radius: 5px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
      width: 300px;
    }
    textarea { width: 100%; height: 150px; }
    button, select { margin-top: 5px; width: 100%; }
    #progressContainer {
      position: absolute; top: 0; left: 0;
      width: 100%; height: 5px;
      background: rgba(200,200,200,0.3);
      z-index: 2000; display: none;
    }
    #progressBar {
      width: 0%; height: 100%; background: #007bff;
      transition: width 0.3s ease;
    }
  </style>
</head>
<body>

<div id="progressContainer"><div id="progressBar"></div></div>

<div id="controls">
  <textarea id="rawData" placeholder="Paste your raw shift data here..."></textarea><br>
  <button id="parseBtn">Parse & Update Map</button>
  <select id="mode">
    <option value="density">Density</option>
    <option value="total">Average Total Pay</option>
    <option value="company">Companies</option>
  </select>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
const map = L.map('map').setView([52.3555, -1.1743], 6);
L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
  attribution: '&copy; OpenStreetMap & CartoDB'
}).addTo(map);

let markersLayer = L.layerGroup().addTo(map);
let lastRendered = '';

document.getElementById('parseBtn').addEventListener('click', updateAll);
document.getElementById('mode').addEventListener('change', updateAll);

function showProgress() {
  const c = document.getElementById('progressContainer'),
        b = document.getElementById('progressBar');
  c.style.display = 'block'; b.style.width = '0%';
  setTimeout(() => b.style.width = '60%', 50);
}
function hideProgress() {
  const c = document.getElementById('progressContainer'),
        b = document.getElementById('progressBar');
  b.style.width = '100%';
  setTimeout(() => { c.style.display = 'none'; b.style.width = '0%'; }, 300);
}

async function updateAll() {
  showProgress();
  try {
    const raw = document.getElementById('rawData').value;
    const shifts = parseData(raw);
    const locations = await geocodeLocations(shifts);
    const renderKey = JSON.stringify({mode: document.getElementById('mode').value, locs: locations});
    if (renderKey !== lastRendered) {
      updateMap(locations);
      lastRendered = renderKey;
    }
  } catch (e) {
    console.error(e);
    alert('Error: ' + e.message);
  }
  hideProgress();
}

function parseData(raw) {
  const lines = raw.split('\n').map(l => l.trim()).filter(l => l);
  const shifts = [];
  for (let i = 0; i < lines.length; i++) {
    if (lines[i].match(/£[\d.]+\/hr/)) {
      const rate = parseFloat(lines[i].match(/£([\d.]+)\/hr/)[1]);
      const company = lines[i-2] && !lines[i-2].match(/£|AM|PM|Logo/) ? lines[i-2] : 'Unknown';
      let location = null;
      for (let j = i+1; j < lines.length; j++) {
        if (lines[j].match(/Total:\s*£[\d,.]+/)) {
          const total = parseFloat(lines[j].match(/£([\d,.]+)/)[1].replace(/,/g,''));
          location = lines.slice(i+1, j).find(l =>
            !l.includes('Logo') && !l.match(/£|AM|PM/) && l.length>1 && l.length<50
          );
          if (location) shifts.push({ location, total, company });
          break;
        }
      }
    }
  }
  return shifts;
}

async function geocodeLocations(shifts) {
  const cacheKey = 'geocodeCache',
        cache = JSON.parse(localStorage.getItem(cacheKey) || '{}');
  const unique = [...new Set(shifts.map(s => s.location))].filter(l => !cache[l]);
  const batchSize = 10;

  for (let i = 0; i < unique.length; i += batchSize) {
    const batch = unique.slice(i, i + batchSize);
    const resArr = await Promise.all(batch.map(async loc => {
      try {
        const r = await fetch(
          `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(loc+", UK")}`,
          { headers: { 'User-Agent': 'LocumMapBot/1.0 (TheOptomCoach@Outlook.com)' } }
        );
        const d = await r.json();
        if (d?.length) cache[loc] = { lat: +d[0].lat, lon: +d[0].lon };
      } catch (e) { console.warn('Geocode error', loc, e); }
    }));
    await new Promise(r => setTimeout(r, 250));
  }
  localStorage.setItem(cacheKey, JSON.stringify(cache));

  const aggregated = {};
  for (const shift of shifts) {
    const loc = shift.location;
    const c = cache[loc];
    if (!c) continue;
    if (!aggregated[loc]) aggregated[loc] = { ...c, totals: [], companies: new Set(), count: 0 };
    const a = aggregated[loc];
    a.totals.push(shift.total);
    a.companies.add(shift.company);
    a.count++;
  }

  return Object.entries(aggregated).map(([loc,data]) => ({
    name: loc, lat: data.lat, lon: data.lon,
    avgTotal: data.totals.reduce((a,b)=>a+b)/data.totals.length,
    count: data.count, companies: [...data.companies]
  }));
}

function updateMap(locs) {
  markersLayer.clearLayers();
  const mode = document.getElementById('mode').value;

  for (const loc of locs) {
    let marker;
    if (mode === 'density') {
      marker = L.circleMarker([loc.lat, loc.lon], {
        radius: 5 + loc.count*3, color: 'blue', fillOpacity: .5
      }).bindPopup(`<b>${loc.name}</b><br>Shifts: ${loc.count}`);
    } else if (mode === 'total') {
      const color = loc.avgTotal >=450 ? 'green' : loc.avgTotal >=350 ? 'orange' : 'red';
      marker = L.circleMarker([loc.lat, loc.lon], { radius:10, color, fillOpacity:.8 })
        .bindPopup(`<b>${loc.name}</b><br>Avg Total: £${loc.avgTotal.toFixed(2)} across ${loc.count} shifts`);
    } else {
      marker = L.marker([loc.lat, loc.lon])
        .bindPopup(`<b>${loc.name}</b><br>Companies: ${loc.companies.join(', ')}`);
    }
    markersLayer.addLayer(marker);
  }
}
</script>

</body>
</html>
