<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>UK Locum Optometry Shifts Heatmap</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { margin: 0; padding: 0; font-family: Arial, sans-serif; }
    #map { height: 100vh; }
    #controls {
      position: absolute;
      top: 10px; left: 10px;
      background: white; padding: 10px; z-index: 1000;
      border-radius: 5px;
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }
    textarea { width: 100%; height: 100px; }
  </style>
</head>
<body>

<div id="controls">
  <textarea id="rawData" placeholder="Paste your raw shift data here..."></textarea><br>
  <button id="parseBtn">Parse & Update Map</button>
  <br><br>
  <label for="mode">Mode:</label>
  <select id="mode">
    <option value="density">Density</option>
    <option value="rate">Average Rate</option>
    <option value="company">Companies</option>
  </select>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<script>
const map = L.map('map').setView([52.3555, -1.1743], 6); // UK center

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution: '&copy; OpenStreetMap'
}).addTo(map);

let heatLayer;
let markersLayer = L.layerGroup().addTo(map);

document.getElementById('parseBtn').addEventListener('click', async () => {
  const raw = document.getElementById('rawData').value;
  const shifts = parseData(raw);

  // Geocode locations
  const locations = await geocodeLocations(shifts);

  updateMap(locations);
});

document.getElementById('mode').addEventListener('change', () => {
  const raw = document.getElementById('rawData').value;
  const shifts = parseData(raw);
  geocodeLocations(shifts).then(updateMap);
});

// Parse the text data into structured objects
function parseData(raw) {
  const entries = raw.split(/\n\n+/);
  let shifts = [];
  for (const entry of entries) {
    const lines = entry.trim().split("\n");
    if (lines.length < 3) continue;

    const location = lines[0].trim();
    const rateLine = lines.find(l => l.includes("£") && l.includes("/hr"));
    const rate = rateLine ? parseFloat(rateLine.match(/£([\d.]+)/)[1]) : null;

    let company = lines.find(l => l.includes("Specsavers") || l.includes("Boots") || l.includes("Virtue") || l.includes("Logo"));
    if (!company) company = "Unknown";

    shifts.push({ location, rate, company });
  }
  return shifts;
}

// Geocode using Nominatim
async function geocodeLocations(shifts) {
  const locationMap = {};

  for (const shift of shifts) {
    if (!locationMap[shift.location]) {
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(shift.location + ", UK")}`;
      const res = await fetch(url);
      const data = await res.json();
      if (data && data.length > 0) {
        locationMap[shift.location] = {
          lat: parseFloat(data[0].lat),
          lon: parseFloat(data[0].lon),
          rates: [shift.rate],
          companies: new Set([shift.company]),
          count: 1
        };
      }
    } else {
      locationMap[shift.location].rates.push(shift.rate);
      locationMap[shift.location].companies.add(shift.company);
      locationMap[shift.location].count++;
    }
  }

  return Object.entries(locationMap).map(([loc, data]) => ({
    name: loc,
    lat: data.lat,
    lon: data.lon,
    avgRate: data.rates.reduce((a, b) => a + b, 0) / data.rates.length,
    count: data.count,
    companies: Array.from(data.companies)
  }));
}

function updateMap(locations) {
  if (heatLayer) {
    map.removeLayer(heatLayer);
  }
  markersLayer.clearLayers();

  const mode = document.getElementById('mode').value;

  if (mode === 'density') {
    const heatPoints = locations.map(loc => [loc.lat, loc.lon, loc.count]);
    heatLayer = L.heatLayer(heatPoints, { radius: 25, maxZoom: 12 }).addTo(map);
  } else if (mode === 'rate') {
    for (const loc of locations) {
      const color = loc.avgRate >= 60 ? "green" : loc.avgRate >= 50 ? "orange" : "red";
      const marker = L.circleMarker([loc.lat, loc.lon], {
        radius: 10,
        color,
        fillOpacity: 0.8
      }).bindPopup(`<b>${loc.name}</b><br>Avg Rate: £${loc.avgRate.toFixed(2)}`);
      markersLayer.addLayer(marker);
    }
  } else if (mode === 'company') {
    for (const loc of locations) {
      const marker = L.marker([loc.lat, loc.lon])
        .bindPopup(`<b>${loc.name}</b><br>Companies: ${loc.companies.join(", ")}`);
      markersLayer.addLayer(marker);
    }
  }
}
</script>

</body>
</html>
